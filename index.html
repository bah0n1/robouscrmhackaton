<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Powerful CRM Frontend</title>
    <!-- 1. Include Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Include Lucide Icon Library -->
    <!-- FIX: Use the standalone 'lucide' library, not 'lucide-react' -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }

        /* Style for the Kanban card being dragged */
        .kanban-card.dragging { opacity: 0.5; transform: rotate(2deg); background: #fef9c3; }
        
        /* Ensure layout is fullscreen */
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Simple bar chart for dashboard */
        .chart-bar { background-color: #3b82f6; /* blue-500 */ transition: height 0.3s ease; }

        /* Modal positioning */
        .modal {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out;
        }
        .modal.hidden .modal-content {
            transform: translateY(-20px);
        }
        
        /* Calendar-specific styles */
        .calendar-day {
            min-height: 8rem; /* 128px */
        }
        .calendar-day:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        .event-pill {
            display: block;
            font-size: 0.75rem; /* text-xs */
            padding: 0.125rem 0.5rem; /* py-0.5 px-2 */
            border-radius: 9999px; /* rounded-full */
            margin-bottom: 0.25rem; /* mb-1 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="flex h-screen bg-white">
        <!-- Sidebar Navigation -->
        <nav class="w-64 flex-shrink-0 border-r border-gray-200 bg-white flex flex-col">
            <div class="h-16 flex-shrink-0 flex items-center justify-center border-b border-gray-200">
                <h2 class="text-2xl font-bold text-indigo-600">ApexCRM</h2>
            </div>
            <div class="flex-grow overflow-y-auto">
                <ul class="py-4">
                    <!-- Main Navigation -->
                    <li><a href="#" class="nav-link active" data-page="page-dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard</a></li>
                    
                    <!-- Sales Group -->
                    <li class="px-6 mt-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Sales</li>
                    <li><a href="#" class="nav-link" data-page="page-contact-list"><i data-lucide="users" class="w-5 h-5 mr-3"></i>Contacts</a></li>
                    <li><a href="#" class="nav-link" data-page="page-company-list"><i data-lucide="building-2" class="w-5 h-5 mr-3"></i>Companies</a></li>
                    <li><a href="#" class="nav-link" data-page="page-deal-pipeline"><i data-lucide="kanban" class="w-5 h-5 mr-3"></i>Deals Pipeline</a></li>
                    
                    <!-- Service Group -->
                    <li class="px-6 mt-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Service</li>
                    <li><a href="#" class="nav-link" data-page="page-ticket-list"><i data-lucide="life-buoy" class="w-5 h-5 mr-3"></i>Support Tickets</a></li>
                    
                    <!-- Marketing Group -->
                    <li class="px-6 mt-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Marketing</li>
                    <li><a href="#" class="nav-link" data-page="page-campaign-list"><i data-lucide="send" class="w-5 h-5 mr-3"></i>Campaigns</a></li>
                    
                    <!-- Analytics & Tools -->
                    <li class="px-6 mt-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Analytics & Tools</li>
                    <li><a href="#" class="nav-link" data-page="page-reports"><i data-lucide="pie-chart" class="w-5 h-5 mr-3"></i>Reports</a></li>
                    <li><a href="#" class="nav-link" data-page="page-automation"><i data-lucide="zap" class="w-5 h-5 mr-3"></i>Automation</a></li>
                    <li><a href="#" class="nav-link" data-page="page-calendar"><i data-lucide="calendar" class="w-5 h-5 mr-3"></i>Calendar</a></li>
                </ul>
            </div>
            <div class="flex-shrink-0 p-4 border-t border-gray-200">
                <div class="flex items-center">
                    <img class="w-10 h-10 rounded-full" src="https://placehold.co/40x40/93c5fd/FFFFFF?text=A" alt="Alex Johnson">
                    <div class="ml-3">
                        <p class="text-sm font-medium text-gray-900">Alex Johnson</p>
                        <p class="text-xs text-gray-500">Sales Manager</p>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto">
            
            <!-- Page: Dashboard (High-Fidelity) -->
            <section id="page-dashboard" class="page p-6 md:p-10">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h1>
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Pipeline Value</span>
                            <i data-lucide="dollar-sign" class="w-5 h-5 text-green-500"></i>
                        </div>
                        <p id="stat-pipeline-value" class="text-3xl font-semibold text-gray-900 mt-2">$0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">New Leads</span>
                            <i data-lucide="user-plus" class="w-5 h-5 text-blue-500"></i>
                        </div>
                        <p id="stat-new-leads" class="text-3xl font-semibold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Open Tickets</span>
                            <i data-lucide="life-buoy" class="w-5 h-5 text-yellow-500"></i>
                        </div>
                        <p id="stat-open-tickets" class="text-3xl font-semibold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Active Campaigns</span>
                            <i data-lucide="send" class="w-5 h-5 text-indigo-500"></i>
                        </div>
                        <p id="stat-active-campaigns" class="text-3xl font-semibold text-gray-900 mt-2">0</p>
                    </div>
                </div>
                
                <!-- Dashboard Columns -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                    <!-- Column 1: Pipeline Chart -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Deal Pipeline by Stage</h3>
                        <div class="h-80 flex items-end gap-2 px-4" id="dashboard-chart-container">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                    
                    <!-- Column 2: My Tasks -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">My Tasks (Demo)</h3>
                        <ul class="divide-y divide-gray-200">
                            <li class="py-3">
                                <p class="font-medium text-gray-900">Follow up with Tech Solutions</p>
                                <p class="text-sm text-red-600">Due Today</p>
                            </li>
                            <li class="py-3">
                                <p class="font-medium text-gray-900">Send proposal to Data Corp</p>
                                <p class="text-sm text-yellow-600">Due Tomorrow</p>
                            </li>
                            <li class="py-3">
                                <p class="font-medium text-gray-900">Prep for Marketing Inc. demo</p>
                                <p class="text-sm text-gray-500">Due in 3 days</p>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
            
            <!-- Page: Contact List View -->
            <section id="page-contact-list" class="page hidden p-6 md:p-10">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Contacts</h1>
                    <button id="add-contact-btn" class="btn-primary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block -mt-1"></i>
                        Add Contact
                    </button>
                </div>
                <!-- Filter Bar -->
                <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
                    <div class="flex gap-2">
                        <select class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <option>All Contacts</option>
                            <option>My Contacts</option>
                            <option>New Leads This Week</option>
                        </select>
                        <button class="btn-secondary-outline">
                            <i data-lucide="filter" class="w-4 h-4 mr-2 inline-block"></i>
                            Add Filter
                        </button>
                    </div>
                    <input type="text" placeholder="Search contacts..." class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <!-- Contacts Table -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="contact-list-table-body">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Page: Company List View -->
            <section id="page-company-list" class="page hidden p-6 md:p-10">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Companies</h1>
                    <button id="add-company-btn" class="btn-primary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block -mt-1"></i>
                        Add Company
                    </button>
                </div>
                 <!-- Companies Table -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Industry</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="company-list-table-body">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Page: Deal Pipeline (Kanban) -->
            <section id="page-deal-pipeline" class="page hidden p-6 md:p-10 flex flex-col h-full">
                <div class="flex items-center justify-between mb-6 flex-shrink-0">
                    <h1 class="text-3xl font-bold text-gray-900">Deals Pipeline</h1>
                    <button id="add-deal-btn" class="btn-primary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block -mt-1"></i>
                        Add Deal
                    </button>
                </div>
                <!-- Kanban Board Wrapper -->
                <div class="flex-grow overflow-x-auto pb-4">
                    <div class="flex gap-6" id="kanban-board-container">
                        <!-- JS will populate columns -->
                    </div>
                </div>
            </section>
            
            <!-- Page: Support Ticket List -->
            <section id="page-ticket-list" class="page hidden p-6 md:p-10">
                 <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Support Tickets</h1>
                    <button id="add-ticket-btn" class="btn-primary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block -mt-1"></i>
                        Add Ticket
                    </button>
                </div>
                 <!-- Tickets Table -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="ticket-list-table-body">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Page: Campaign List -->
            <section id="page-campaign-list" class="page hidden p-6 md:p-10">
                 <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Marketing Campaigns</h1>
                    <button id="add-campaign-btn" class="btn-primary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block -mt-1"></i>
                        Add Campaign
                    </button>
                </div>
                 <!-- Campaigns Table -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Campaign Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Channel</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="campaign-list-table-body">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Page: Reports (Placeholder) -->
            <section id="page-reports" class="page hidden p-6 md:p-10">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Reports</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-96 flex items-center justify-center text-gray-500">
                        Chart: Deal Conversion Rate by Source
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-96 flex items-center justify-center text-gray-500">
                        Chart: Ticket Resolution Time by Agent
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-96 flex items-center justify-center text-gray-500">
                        Report: Campaign ROI
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 h-96 flex items-center justify-center text-gray-500">
                        Chart: Sales Revenue Forecast
                    </div>
                </div>
            </section>

            <!-- Page: Automation (Placeholder) -->
            <section id="page-automation" class="page hidden p-6 md:p-10">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Automations / Workflows</h1>
                    <button class="btn-primary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block -mt-1"></i>
                        New Workflow
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Example: New Lead Nurturing</h3>
                    <!-- Fake flow chart -->
                    <div class="flex items-center gap-4 text-sm">
                        <div class="bg-blue-100 text-blue-800 p-4 rounded-lg shadow-sm">
                            <p class="font-bold">WHEN:</p>
                            <p>Contact Created</p>
                            <p>(Status = Lead)</p>
                        </div>
                        <i data-lucide="arrow-right" class="w-6 h-6 text-gray-400"></i>
                        <div class="bg-green-100 text-green-800 p-4 rounded-lg shadow-sm">
                            <p class="font-bold">THEN:</p>
                            <p>Send 'Welcome' Email</p>
                        </div>
                        <i data-lucide="arrow-right" class="w-6 h-6 text-gray-400"></i>
                        <div class="bg-yellow-100 text-yellow-800 p-4 rounded-lg shadow-sm">
                            <p class="font-bold">AND:</p>
                            <p>Create Task for Owner</p>
                            <p>(Due in 2 days)</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Page: Calendar (Placeholder) -->
            <section id="page-calendar" class="page hidden p-6 md:p-10 flex flex-col h-full">
                <!-- Calendar Header -->
                <div class="flex items-center justify-between mb-6 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <h1 id="calendar-month-year" class="text-3xl font-bold text-gray-900">November 2025</h1>
                        <button id="calendar-today-btn" class="btn-secondary-outline">Today</button>
                        <button id="calendar-prev-btn" class="btn-secondary-outline px-2 py-1">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <button id="calendar-next-btn" class="btn-secondary-outline px-2 py-1">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button id="add-event-btn" class="btn-primary">
                        <i data-lucide="plus" class="w-4 h-4 mr-2 inline-block -mt-1"></i>
                        New Event
                    </button>
                </div>
                
                <!-- Calendar Grid Wrapper -->
                <div class="flex-grow overflow-y-auto bg-white rounded-lg shadow-sm border border-gray-200">
                    <!-- Day of Week Headers -->
                    <div class="grid grid-cols-7 gap-px border-b border-gray-200">
                        <div class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Sun</div>
                        <div class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Mon</div>
                        <div class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Tue</div>
                        <div class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Wed</div>
                        <div class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Thu</div>
                        <div class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Fri</div>
                        <div class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Sat</div>
                    </div>
                    <!-- Calendar Date Grid -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200">
                        <!-- JS will populate this -->
                    </div>
                </div>
            </section>


            <!-- ########################################## -->
            <!-- #####   CONTACT DETAIL PAGE (DYNAMIC)  ##### -->
            <!-- ########################################## -->
            <section id="page-contact-detail" class="page hidden flex flex-col h-full">
                <!-- Detail Page Header -->
                <div class="flex-shrink-0 bg-white p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button class="btn-secondary-outline" id="back-to-contacts-btn">
                                <i data-lucide="arrow-left" class="w-4 h-4 inline-block"></i>
                                Back
                            </button>
                            <h1 id="contact-detail-name" class="text-3xl font-bold text-gray-900"></h1>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn-secondary" id="contact-detail-edit-btn">Edit</button>
                        </div>
                    </div>
                </div>

                <!-- 3-Column Layout -->
                <div class="flex-grow overflow-y-auto p-6 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Left Column: Details -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Details</h3>
                            <div class="space-y-3">
                                <div class="text-sm">
                                    <p class="text-gray-500">Email</p>
                                    <p class="font-medium text-gray-900" id="contact-detail-email"></p>
                                </div>
                                <div class="text-sm">
                                    <p class="text-gray-500">Phone</p>
                                    <p class="font-medium text-gray-900" id="contact-detail-phone"></p>
                                </div>
                                <div class="text-sm">
                                    <p class="text-gray-500">Owner</p>
                                    <p class="font-medium text-gray-900" id="contact-detail-owner"></p>
                                </div>
                                <div class="text-sm">
                                    <p class="text-gray-500">Status</p>
                                    <p class="font-medium text-gray-900" id="contact-detail-status"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Center Column: Activity Timeline -->
                    <div class="lg:col-span-1 space-y-6">
                        <!-- Activity Composer -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                            <div class="border-b border-gray-200">
                                <nav class="flex -mb-px" id="activity-tabs">
                                    <button class="activity-tab active" data-tab="log-call">
                                        <i data-lucide="phone" class="w-4 h-4 mr-2"></i>Log Call
                                    </button>
                                    <button class="activity-tab" data-tab="log-email">
                                        <i data-lucide="mail" class="w-4 h-4 mr-2"></i>Email
                                    </button>
                                    <button class="activity-tab" data-tab="log-meeting">
                                        <i data-lucide="calendar-plus" class="w-4 h-4 mr-2"></i>Meeting
                                    </button>
                                </nav>
                            </div>
                            <div class="p-6">
                                <div id="tab-log-call" class="activity-tab-content">
                                    <textarea id="log-call-notes" class="form-input" rows="3" placeholder="Enter call notes..."></textarea>
                                    <button id="log-call-btn" class="btn-primary w-full mt-2">Log Call</button>
                                </div>
                                <div id="tab-log-email" class="activity-tab-content hidden">
                                    <input id="log-email-subject" type="text" class="form-input mb-2" placeholder="Subject">
                                    <textarea id="log-email-body" class="form-input" rows="3" placeholder="Write your email..."></textarea>
                                    <button id="log-email-btn" class="btn-primary w-full mt-2">Send Email</button>
                                </div>
                                <div id="tab-log-meeting" class="activity-tab-content hidden">
                                    <input id="log-meeting-title" type="text" class="form-input mb-2" placeholder="Meeting Title">
                                    <input id="log-meeting-date" type="datetime-local" class="form-input mb-2">
                                    <textarea id="log-meeting-agenda" class_-"form-input" rows="2" placeholder="Agenda..."></textarea>
                                    <button id="log-meeting-btn" class="btn-primary w-full mt-2">Schedule Meeting</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Timeline -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Activity Timeline</h3>
                            <ul class="space-y-6" id="contact-detail-timeline">
                                <!-- JS will populate this -->
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Right Column: Related Lists -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Related Company</h3>
                            <div id="contact-detail-related-company">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Related Deals</h3>
                            <ul class="divide-y divide-gray-200" id="contact-detail-related-deals">
                                <!-- JS will populate this -->
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Related Tickets</h3>
                            <ul class="divide-y divide-gray-200" id="contact-detail-related-tickets">
                                <!-- JS will populate this -->
                            </ul>
                        </div>
                    </div>

                </div>
            </section>

        </main>
    </div>
    
    <!-- ######################## -->
    <!-- ##### ALL MODALS ##### -->
    <!-- ######################## -->

    <!-- Contact Modal -->
    <div id="contact-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 id="contact-modal-title" class="text-2xl font-bold mb-6">Add New Contact</h2>
            <form id="contact-form" class="space-y-4">
                <input type="hidden" id="contact-id">
                <div>
                    <label for="contact-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="contact-name" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="contact-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="contact-email" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="contact-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="contact-phone" class="form-input mt-1">
                </div>
                <div>
                    <label for="contact-company-select" class="block text-sm font-medium text-gray-700">Company</label>
                    <select id="contact-company-select" class="form-input mt-1"></select>
                </div>
                <div>
                    <label for="contact-status-select" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="contact-status-select" class="form-input mt-1"></select>
                </div>
                <div>
                    <label for="contact-owner-select" class="block text-sm font-medium text-gray-700">Owner</label>
                    <select id="contact-owner-select" class="form-input mt-1"></select>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Contact</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Company Modal -->
    <div id="company-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 id="company-modal-title" class="text-2xl font-bold mb-6">Add New Company</h2>
            <form id="company-form" class="space-y-4">
                <input type="hidden" id="company-id">
                <div>
                    <label for="company-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                    <input type="text" id="company-name" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="company-industry" class="block text-sm font-medium text-gray-700">Industry</label>
                    <input type="text" id="company-industry" class="form-input mt-1">
                </div>
                <div>
                    <label for="company-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="company-phone" class="form-input mt-1">
                </div>
                <div>
                    <label for="company-owner-select" class="block text-sm font-medium text-gray-700">Owner</label>
                    <select id="company-owner-select" class="form-input mt-1"></select>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Company</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Deal Modal -->
    <div id="deal-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 id="deal-modal-title" class="text-2xl font-bold mb-6">Add New Deal</h2>
            <form id="deal-form" class="space-y-4">
                <input type="hidden" id="deal-id">
                <div>
                    <label for="deal-name" class="block text-sm font-medium text-gray-700">Deal Name</label>
                    <input type="text" id="deal-name" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="deal-company-select" class="block text-sm font-medium text-gray-700">Company</label>
                    <select id="deal-company-select" class="form-input mt-1"></select>
                </div>
                <div>
                    <label for="deal-value" class="block text-sm font-medium text-gray-700">Value ($)</label>
                    <input type="number" id="deal-value" class="form-input mt-1">
                </div>
                <div>
                    <label for="deal-stage-select" class="block text-sm font-medium text-gray-700">Stage</label>
                    <select id="deal-stage-select" class="form-input mt-1"></select>
                </div>
                <div>
                    <label for="deal-owner-select" class="block text-sm font-medium text-gray-700">Owner</label>
                    <select id="deal-owner-select" class="form-input mt-1"></select>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Deal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ticket Modal -->
    <div id="ticket-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 id="ticket-modal-title" class="text-2xl font-bold mb-6">Add New Ticket</h2>
            <form id="ticket-form" class="space-y-4">
                <input type="hidden" id="ticket-id">
                <div>
                    <label for="ticket-subject" class="block text-sm font-medium text-gray-700">Subject</label>
                    <input type="text" id="ticket-subject" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="ticket-contact-select" class="block text-sm font-medium text-gray-700">Customer (Contact)</label>
                    <select id="ticket-contact-select" class="form-input mt-1"></select>
                </div>
                <div>
                    <label for="ticket-status-select" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="ticket-status-select" class="form-input mt-1"></select>
                </div>
                <div>
                    <label for="ticket-assignee-select" class="block text-sm font-medium text-gray-700">Assigned To</label>
                    <select id="ticket-assignee-select" class="form-input mt-1"></select>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Ticket</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Campaign Modal -->
    <div id="campaign-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 id="campaign-modal-title" class="text-2xl font-bold mb-6">Add New Campaign</h2>
            <form id="campaign-form" class="space-y-4">
                <input type="hidden" id="campaign-id">
                <div>
                    <label for="campaign-name" class="block text-sm font-medium text-gray-700">Campaign Name</label>
                    <input type="text" id="campaign-name" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="campaign-status-select" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="campaign-status-select" class="form-input mt-1"></select>
                </div>
                <div>
                    <label for="campaign-budget" class="block text-sm font-medium text-gray-700">Budget ($)</label>
                    <input type="number" id="campaign-budget" class="form-input mt-1">
                </div>
                <div>
                    <label for="campaign-channel-select" class="block text-sm font-medium text-gray-700">Channel</label>
                    <select id="campaign-channel-select" class="form-input mt-1"></select>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Campaign</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Event Modal (NEW) -->
    <div id="event-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 id="event-modal-title" class="text-2xl font-bold mb-6">Add New Event</h2>
            <form id="event-form" class="space-y-4">
                <input type="hidden" id="event-id">
                <div>
                    <label for="event-title" class="block text-sm font-medium text-gray-700">Event Title</label>
                    <input type="text" id="event-title" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="event-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="event-date" class="form-input mt-1" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-start-time" class="block text-sm font-medium text-gray-700">Start Time</label>
                        <input type="time" id="event-start-time" class="form-input mt-1">
                    </div>
                    <div>
                        <label for="event-end-time" class="block text-sm font-medium text-gray-700">End Time</label>
                        <input type="time" id="event-end-time" class="form-input mt-1">
                    </div>
                </div>
                <div>
                    <label for="event-type-select" class="block text-sm font-medium text-gray-700">Event Type</label>
                    <select id="event-type-select" class="form-input mt-1"></select>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" class="btn-secondary modal-close-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Event</button>
                </div>
            </form>
        </div>
    </div>


    <!-- 3. Custom Styles for Components -->
    <style>
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem; /* 12px 24px */
            margin: 0.25rem 1rem; /* 4px 16px */
            border-radius: 0.375rem; /* rounded-md */
            color: #374151; /* gray-700 */
            font-weight: 500; /* medium */
            transition: all 0.2s ease-in-out;
        }
    </style>

    <!-- 4. JavaScript Application Logic -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // --- MOCK DATABASE ---
            let users = {
                1: { name: "Alex Johnson", team: "Sales" },
                2: { name: "Sarah Chen", team: "Sales" },
                3: { name: "David Kim", team: "Sales" },
                4: { name: "Maria Garcia", team: "Marketing" },
                5: { name: "James Smith", team: "Support" },
            };

            let companies = [
                { id: 101, name: "Tech Solutions", industry: "Technology", phone: "555-1234", owner: 2 },
                { id: 102, name: "Marketing Inc.", industry: "Marketing", phone: "555-5678", owner: 3 },
                { id: 103, name: "Web Designers", industry: "Design", phone: "555-8765", owner: 2 },
                { id: 104, name: "Data Corp", industry: "Analytics", phone: "555-4321", owner: 1 },
            ];

            let contacts = [
                { id: 1, name: "John Doe", email: "john@techsolutions.com", phone: "555-1234", companyId: 101, status: "Lead", owner: 2 },
                { id: 2, name: "Jane Smith", email: "jane@marketinginc.com", phone: "555-5678", companyId: 102, status: "Customer", owner: 3 },
                { id: 3, name: "Mike Johnson", email: "mike@webdesigners.com", phone: "555-8765", companyId: 103, status: "Contacted", owner: 2 },
                { id: 4, name: "Emily White", email: "emily@datacorp.com", phone: "555-4321", companyId: 104, status: "Lead", owner: 1 },
            ];
            
            const CONTACT_STATUSES = ["Lead", "Contacted", "Proposal", "Customer", "Lost"];
            const DEAL_STAGES = ["New Lead", "Contacted", "Proposal Sent", "Negotiation", "Won", "Lost"];
            const TICKET_STATUSES = ["New", "Open", "Pending", "Closed"];
            const CAMPAIGN_STATUSES = ["Planning", "Active", "Finished", "Cancelled"];
            const CAMPAIGN_CHANNELS = ["Email", "Social Media", "Google Ads", "Webinar", "Trade Show"];
            const EVENT_TYPES = ["Meeting", "Call", "Task", "Deadline"];

            let deals = [
                { id: 201, name: "Tech Solutions Website", companyId: 101, value: 15000, stage: "Proposal Sent", owner: 2, contactIds: [1] },
                { id: 202, name: "Marketing Inc. Campaign", companyId: 102, value: 30000, stage: "Won", owner: 3, contactIds: [2] },
                { id: 203, name: "Web Designers SEO", companyId: 103, value: 5000, stage: "Negotiation", owner: 2, contactIds: [3] },
                { id: 204, name: "Data Corp Analytics", companyId: 104, value: 25000, stage: "New Lead", owner: 1, contactIds: [4] },
                { id: 205, name: "Tech Solutions Retainer", companyId: 101, value: 50000, stage: "Contacted", owner: 1, contactIds: [1] },
            ];
            
            let tickets = [
                { id: 301, subject: "Billing Question", contactId: 2, status: "Open", assignee: 5 },
                { id: 302, subject: "Can't log in", contactId: 3, status: "New", assignee: 5 },
                { id: 303, subject: "Product Idea", contactId: 1, status: "Closed", assignee: 5 },
            ];
            
            let campaigns = [
                { id: 401, name: "Q4 Newsletter", status: "Active", budget: 1500, channel: "Email" },
                { id: 402, name: "Spring Sale Social", status: "Planning", budget: 5000, channel: "Social Media" },
                { id: 403, name: "Analytics Webinar", status: "Finished", budget: 2500, channel: "Webinar" },
            ];

            let activities = [
                { id: 501, type: "email", contactId: 2, date: "2 days ago", user: "Sarah Chen", subject: "Re: Quick Question", body: "Just following up on our chat..." },
                { id: 502, type: "call", contactId: 2, date: "Yesterday", user: "Sarah Chen", notes: "Spoke with Jane about the new campaign. She's interested in the premium package. Sent proposal." },
                { id: 503, type: "meeting", contactId: 2, date: "Today @ 10:00 AM", user: "Sarah Chen", title: "Project Kickoff", agenda: "Discuss timeline and deliverables." },
                { id: 504, type: "email", contactId: 1, date: "3 days ago", user: "Alex Johnson", subject: "Introductory Call", body: "Hi John, excited to chat..." },
            ];
            
            let events = [
                { id: 601, title: "Team Standup", date: "2025-11-03", startTime: "09:00", endTime: "09:15", type: "Meeting" },
                { id: 602, title: "Follow up w/ Tech Solutions", date: "2025-11-04", startTime: "10:00", endTime: "10:30", type: "Call" },
                { id: 603, title: "Send Proposal to Data Corp", date: "2025-11-05", startTime: "", endTime: "", type: "Task" },
                { id: 604, title: "Q4 Marketing Sync", date: "2025-11-05", startTime: "14:00", endTime: "15:00", type: "Meeting" },
                { id: 605, title: "Project Deadline", date: "2025-11-14", startTime: "17:00", endTime: "", type: "Deadline" },
            ];
            
            // --- Global State ---
            let currentContactId = null; // For the detail page
            let currentCalendarDate = new Date("2025-11-01"); // Set a fixed date for demo
            
            // --- Utility Functions ---
            
            function escapeHTML(str) {
                if (!str) return "";
                return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            }
            
            function getNextId(arr) {
                if (arr.length === 0) return 1;
                return Math.max(...arr.map(item => item.id)) + 1;
            }
            
            // --- SPA Navigation ---
            const navLinks = document.querySelectorAll(".nav-link");
            const pages = document.querySelectorAll(".page");

            navLinks.forEach(link => {
                link.addEventListener("click", e => {
                    e.preventDefault();
                    const pageId = link.dataset.page;
                    showPage(pageId);
                });
            });

            function showPage(pageId) {
                 // Show target page, hide others
                pages.forEach(p => p.classList.add("hidden"));
                document.getElementById(pageId).classList.remove("hidden");
                
                // Set active link
                navLinks.forEach(l => l.classList.remove("active"));
                const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
                if (activeLink) {
                    activeLink.classList.add("active");
                }
            }

            // --- Render Dashboard ---
            function renderDashboard() {
                // Stats
                const pipelineValue = deals
                    .filter(d => d.stage !== "Won" && d.stage !== "Lost")
                    .reduce((sum, d) => sum + d.value, 0);
                document.getElementById("stat-pipeline-value").textContent = `$${pipelineValue.toLocaleString()}`;
                
                const newLeads = contacts.filter(c => c.status === "Lead").length;
                document.getElementById("stat-new-leads").textContent = newLeads;

                const openTickets = tickets.filter(t => t.status !== "Closed").length;
                document.getElementById("stat-open-tickets").textContent = openTickets;
                
                const activeCampaigns = campaigns.filter(c => c.status === "Active").length;
                document.getElementById("stat-active-campaigns").textContent = activeCampaigns;

                // Chart
                const chartContainer = document.getElementById("dashboard-chart-container");
                chartContainer.innerHTML = "";
                let maxStageValue = 0;
                const stageValues = DEAL_STAGES.filter(s => s !== "Won" && s !== "Lost").map(stage => {
                    const value = deals.filter(d => d.stage === stage).reduce((sum, d) => sum + d.value, 0);
                    if (value > maxStageValue) maxStageValue = value;
                    return { stage, value };
                });
                
                if (maxStageValue === 0) maxStageValue = 1; // Avoid division by zero
                
                stageValues.forEach(item => {
                    const heightPercent = (item.value / maxStageValue) * 100;
                    chartContainer.innerHTML += `
                        <div class="flex-1 flex flex-col items-center">
                            <div class="chart-bar w-full rounded-t" style="height: ${heightPercent}%"></div>
                            <span class="text-xs text-gray-500 mt-2">${escapeHTML(item.stage)}</span>
                        </div>
                    `;
                });
            }

            // --- Render List Views ---

            function renderContactList() {
                const tbody = document.getElementById("contact-list-table-body");
                tbody.innerHTML = "";
                contacts.forEach(contact => {
                    const company = companies.find(c => c.id === contact.companyId);
                    const owner = users[contact.owner];
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <a href="#" class="text-indigo-600 hover:text-indigo-900 font-medium contact-detail-link" data-id="${contact.id}">
                                    ${escapeHTML(contact.name)}
                                </a>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(contact.email)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${company ? escapeHTML(company.name) : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${owner ? escapeHTML(owner.name) : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(contact.status)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button class="btn-edit-outline contact-edit-btn" data-id="${contact.id}">Edit</button>
                                <button class="btn-danger-outline contact-delete-btn" data-id="${contact.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            }

            function renderCompanyList() {
                const tbody = document.getElementById("company-list-table-body");
                tbody.innerHTML = "";
                companies.forEach(company => {
                    const owner = users[company.owner];
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${escapeHTML(company.name)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(company.industry)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(company.phone)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${owner ? escapeHTML(owner.name) : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button class="btn-edit-outline company-edit-btn" data-id="${company.id}">Edit</button>
                                <button class="btn-danger-outline company-delete-btn" data-id="${company.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            function renderTicketList() {
                const tbody = document.getElementById("ticket-list-table-body");
                tbody.innerHTML = "";
                tickets.forEach(ticket => {
                    const contact = contacts.find(c => c.id === ticket.contactId);
                    const assignee = users[ticket.assignee];
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-500">#${ticket.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHTML(ticket.subject)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${contact ? escapeHTML(contact.name) : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(ticket.status)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignee ? escapeHTML(assignee.name) : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button class="btn-edit-outline ticket-edit-btn" data-id="${ticket.id}">Edit</button>
                                <button class="btn-danger-outline ticket-delete-btn" data-id="${ticket.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            function renderCampaignList() {
                const tbody = document.getElementById("campaign-list-table-body");
                tbody.innerHTML = "";
                campaigns.forEach(campaign => {
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHTML(campaign.name)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(campaign.status)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${campaign.budget.toLocaleString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHTML(campaign.channel)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                <button class="btn-edit-outline campaign-edit-btn" data-id="${campaign.id}">Edit</button>
                                <button class="btn-danger-outline campaign-delete-btn" data-id="${campaign.id}">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            function renderKanbanBoard() {
                const container = document.getElementById("kanban-board-container");
                container.innerHTML = "";
                
                DEAL_STAGES.forEach(stage => {
                    const column = document.createElement("div");
                    column.className = "w-80 flex-shrink-0 bg-gray-100 rounded-lg p-3";
                    column.dataset.stage = stage;
                    
                    const dealsInStage = deals.filter(d => d.stage === stage);
                    const stageValue = dealsInStage.reduce((sum, deal) => sum + deal.value, 0);
                    
                    column.innerHTML = `
                        <h3 class="font-semibold text-gray-900 mb-2">${escapeHTML(stage)}</h3>
                        <p class="text-sm text-gray-500 mb-4">$${stageValue.toLocaleString()} &bull; ${dealsInStage.length} deals</p>
                        <div class="space-y-3 kanban-cards">
                            ${dealsInStage.map(deal => {
                                const company = companies.find(c => c.id === deal.companyId);
                                return `
                                    <div class="kanban-card bg-white p-4 rounded-md shadow border border-gray-200" draggable="true" data-id="${deal.id}">
                                        <div class="flex justify-between items-start">
                                            <p class="font-medium text-gray-900">${escapeHTML(deal.name)}</p>
                                            <button class="deal-edit-btn" data-id="${deal.id}"><i data-lucide="edit-2" class="w-3 h-3 text-gray-400 hover:text-indigo-600"></i></button>
                                        </div>
                                        <p class="text-sm text-gray-500">${company ? escapeHTML(company.name) : 'N/A'}</p>
                                        <p class="text-sm font-semibold text-green-600 mt-1">$${deal.value.toLocaleString()}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    container.appendChild(column);
                });
                lucide.createIcons();
            }
            
            // --- Calendar Logic ---
            
            function renderCalendar(year, month) {
                const grid = document.getElementById("calendar-grid");
                grid.innerHTML = "";
                
                const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });
                document.getElementById("calendar-month-year").textContent = `${monthName} ${year}`;
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                
                // 1. Add blank padding days
                for (let i = 0; i < firstDay; i++) {
                    grid.innerHTML += `<div class="calendar-day bg-gray-50 p-2"></div>`;
                }
                
                // 2. Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                    
                    // Find events for this day
                    const dayEvents = events.filter(e => e.date === dateStr).sort((a,b) => (a.startTime || "23:59").localeCompare(b.startTime || "23:59"));
                    
                    let eventsHtml = dayEvents.map(event => {
                        let bgColor = "bg-blue-100 text-blue-800";
                        if (event.type === "Call") bgColor = "bg-green-100 text-green-800";
                        if (event.type === "Task") bgColor = "bg-yellow-100 text-yellow-800";
                        if (event.type === "Deadline") bgColor = "bg-red-100 text-red-800";
                        
                        const time = event.startTime ? `${event.startTime} ` : '';
                        return `<span class="event-pill ${bgColor} event-edit-btn" data-id="${event.id}">
                                    ${escapeHTML(time + event.title)}
                                </span>`;
                    }).join('');

                    grid.innerHTML += `
                        <div class="calendar-day bg-white p-2 border-l border-b border-gray-200 relative add-event-on-date" data-date="${dateStr}">
                            <time class="text-sm font-medium ${isToday ? 'text-white bg-indigo-600 rounded-full w-6 h-6 flex items-center justify-center' : 'text-gray-900'}">
                                ${day}
                            </time>
                            <div class="mt-1 space-y-1">
                                ${eventsHtml}
                            </div>
                        </div>
                    `;
                }
                lucide.createIcons();
            }

            // --- Detail Page Logic ---
            
            function showContactDetail(contactId) {
                currentContactId = contactId;
                const contact = contacts.find(c => c.id === contactId);
                if (!contact) return;
                
                // 1. Hide list pages, show detail page
                showPage("page-contact-detail");
                
                // 2. Populate Header
                document.getElementById("contact-detail-name").textContent = contact.name;
                document.getElementById("contact-detail-edit-btn").dataset.id = contact.id;
                
                // 3. Populate Details Column
                document.getElementById("contact-detail-email").textContent = contact.email;
                document.getElementById("contact-detail-phone").textContent = contact.phone;
                document.getElementById("contact-detail-owner").textContent = users[contact.owner]?.name || 'N/A';
                document.getElementById("contact-detail-status").textContent = contact.status;
                
                // 4. Populate Activity Timeline
                renderActivityTimeline(contactId);
                
                // 5. Populate Related Company
                const relatedCompanyContainer = document.getElementById("contact-detail-related-company");
                const company = companies.find(c => c.id === contact.companyId);
                if (company) {
                    relatedCompanyContainer.innerHTML = `
                        <div class="p-4 border border-gray-200 rounded-md hover:bg-gray-50">
                            <a href="#" class="font-semibold text-indigo-600">${escapeHTML(company.name)}</a>
                            <p class="text-sm text-gray-500">${escapeHTML(company.industry)}</p>
                        </div>
                    `;
                } else {
                    relatedCompanyContainer.innerHTML = `<p class="text-sm text-gray-500">No related company.</p>`;
                }

                // 6. Populate Related Deals
                const relatedDealsContainer = document.getElementById("contact-detail-related-deals");
                const relatedDeals = deals.filter(d => d.contactIds.includes(contactId));
                relatedDealsContainer.innerHTML = "";
                if (relatedDeals.length > 0) {
                    relatedDeals.forEach(deal => {
                        relatedDealsContainer.innerHTML += `
                            <li class="py-3">
                                <a href="#" class="font-medium text-indigo-600">${escapeHTML(deal.name)}</a>
                                <p class="text-sm text-gray-500">$${deal.value.toLocaleString()} &bull; <span class="font-medium">${escapeHTML(deal.stage)}</span></p>
                            </li>
                        `;
                    });
                } else {
                    relatedDealsContainer.innerHTML = `<li class="py-3 text-sm text-gray-500">No related deals.</li>`;
                }
                
                // 7. Populate Related Tickets
                const relatedTicketsContainer = document.getElementById("contact-detail-related-tickets");
                const relatedTickets = tickets.filter(t => t.contactId === contactId);
                relatedTicketsContainer.innerHTML = "";
                if (relatedTickets.length > 0) {
                    relatedTickets.forEach(ticket => {
                        relatedTicketsContainer.innerHTML += `
                            <li class="py-3">
                                <a href="#" class="font-medium text-indigo-600">Ticket #${ticket.id}: ${escapeHTML(ticket.subject)}</a>
                                <p class="text-sm text-gray-500">Status: <span class="font-medium">${escapeHTML(ticket.status)}</span></p>
                            </li>
                        `;
                    });
                } else {
                    relatedTicketsContainer.innerHTML = `<li class="py-3 text-sm text-gray-500">No related tickets.</li>`;
                }

                // Re-run Lucide to render new icons
                lucide.createIcons();
            }
            
            function renderActivityTimeline(contactId) {
                const timelineContainer = document.getElementById("contact-detail-timeline");
                timelineContainer.innerHTML = "";
                const contactActivities = activities.filter(a => a.contactId === contactId).sort((a, b) => b.id - a.id); // simple sort
                
                contactActivities.forEach(activity => {
                    let icon = 'pencil';
                    let title = '';
                    let body = '';
                    
                    if (activity.type === 'call') {
                        icon = 'phone';
                        title = `Logged a call`;
                        body = `<p class="text-sm text-gray-700">${escapeHTML(activity.notes)}</p>`;
                    } else if (activity.type === 'email') {
                        icon = 'mail';
                        title = `Emailed: ${escapeHTML(activity.subject)}`;
                        body = `<div class="text-sm text-gray-600 border-l-2 border-gray-300 pl-2 italic mt-1">${escapeHTML(activity.body)}</div>`;
                    } else if (activity.type === 'meeting') {
                        icon = 'calendar-plus';
                        title = `Meeting scheduled: ${escapeHTML(activity.title)}`;
                        body = `<p class="text-sm text-gray-700">${escapeHTML(activity.agenda)}</p>`;
                    }
                    
                    timelineContainer.innerHTML += `
                        <li class="flex gap-4">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center">
                                <i data-lucide="${icon}" class="w-4 h-4 text-gray-500"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm font-medium text-gray-900">${title}</p>
                                <p class="text-xs text-gray-500">${escapeHTML(activity.user)} &bull; ${escapeHTML(activity.date)}</p>
                                ${body}
                            </div>
                        </li>
                    `;
                });
                lucide.createIcons();
            }

            // --- Modal Open/Close ---
            
            const allModals = document.querySelectorAll(".modal");
            allModals.forEach(modal => {
                const closeBtn = modal.querySelector(".modal-close-btn");
                closeBtn.addEventListener("click", () => {
                    modal.classList.add("hidden");
                });
            });

            function populateSelect(selectEl, data, textProp, valueProp) {
                selectEl.innerHTML = "";
                data.forEach(item => {
                    selectEl.innerHTML += `<option value="${item[valueProp]}">${escapeHTML(item[textProp])}</option>`;
                });
            }
            
            function populateSelectKeyVal(selectEl, data) {
                selectEl.innerHTML = "";
                for (const key in data) {
                    selectEl.innerHTML += `<option value="${key}">${escapeHTML(data[key].name)}</option>`;
                }
            }

            function populateSelectArray(selectEl, arr) {
                selectEl.innerHTML = "";
                arr.forEach(item => {
                    selectEl.innerHTML += `<option value="${item}">${item}</option>`;
                });
            }

            // Contact Modal
            document.getElementById("add-contact-btn").addEventListener("click", () => openContactModal());
            
            function openContactModal(contactId = null) {
                const modal = document.getElementById("contact-modal");
                const form = document.getElementById("contact-form");
                form.reset();
                document.getElementById("contact-id").value = "";
                
                // Populate selects
                populateSelect(document.getElementById("contact-company-select"), companies, "name", "id");
                populateSelectKeyVal(document.getElementById("contact-owner-select"), users);
                populateSelectArray(document.getElementById("contact-status-select"), CONTACT_STATUSES);

                if (contactId) {
                    // Edit Mode
                    document.getElementById("contact-modal-title").textContent = "Edit Contact";
                    const contact = contacts.find(c => c.id === contactId);
                    if (contact) {
                        document.getElementById("contact-id").value = contact.id;
                        document.getElementById("contact-name").value = contact.name;
                        document.getElementById("contact-email").value = contact.email;
                        document.getElementById("contact-phone").value = contact.phone;
                        document.getElementById("contact-company-select").value = contact.companyId;
                        document.getElementById("contact-status-select").value = contact.status;
                        document.getElementById("contact-owner-select").value = contact.owner;
                    }
                } else {
                    // Add Mode
                    document.getElementById("contact-modal-title").textContent = "Add New Contact";
                }
                modal.classList.remove("hidden");
            }
            
            document.getElementById("contact-form").addEventListener("submit", e => {
                e.preventDefault();
                const id = parseInt(document.getElementById("contact-id").value);
                const contactData = {
                    name: document.getElementById("contact-name").value,
                    email: document.getElementById("contact-email").value,
                    phone: document.getElementById("contact-phone").value,
                    companyId: parseInt(document.getElementById("contact-company-select").value),
                    status: document.getElementById("contact-status-select").value,
                    owner: parseInt(document.getElementById("contact-owner-select").value),
                };

                if (id) {
                    const index = contacts.findIndex(c => c.id === id);
                    if (index !== -1) contacts[index] = { ...contacts[index], ...contactData };
                } else {
                    contactData.id = getNextId(contacts);
                    contacts.push(contactData);
                }
                
                renderContactList();
                renderDashboard();
                document.getElementById("contact-modal").classList.add("hidden");
            });
            
            // Company Modal
            document.getElementById("add-company-btn").addEventListener("click", () => openCompanyModal());
            
            function openCompanyModal(companyId = null) {
                const modal = document.getElementById("company-modal");
                const form = document.getElementById("company-form");
                form.reset();
                document.getElementById("company-id").value = "";
                
                populateSelectKeyVal(document.getElementById("company-owner-select"), users);

                if (companyId) {
                    document.getElementById("company-modal-title").textContent = "Edit Company";
                    const company = companies.find(c => c.id === companyId);
                    if (company) {
                        document.getElementById("company-id").value = company.id;
                        document.getElementById("company-name").value = company.name;
                        document.getElementById("company-industry").value = company.industry;
                        document.getElementById("company-phone").value = company.phone;
                        document.getElementById("company-owner-select").value = company.owner;
                    }
                } else {
                    document.getElementById("company-modal-title").textContent = "Add New Company";
                }
                modal.classList.remove("hidden");
            }

            document.getElementById("company-form").addEventListener("submit", e => {
                e.preventDefault();
                const id = parseInt(document.getElementById("company-id").value);
                const companyData = {
                    name: document.getElementById("company-name").value,
                    industry: document.getElementById("company-industry").value,
                    phone: document.getElementById("company-phone").value,
                    owner: parseInt(document.getElementById("company-owner-select").value),
                };

                if (id) {
                    const index = companies.findIndex(c => c.id === id);
                    if (index !== -1) companies[index] = { ...companies[index], ...companyData };
                } else {
                    companyData.id = getNextId(companies);
                    companies.push(companyData);
                }
                
                renderCompanyList();
                document.getElementById("company-modal").classList.add("hidden");
            });

            // Deal Modal
            document.getElementById("add-deal-btn").addEventListener("click", () => openDealModal());
            
            function openDealModal(dealId = null) {
                const modal = document.getElementById("deal-modal");
                const form = document.getElementById("deal-form");
                form.reset();
                document.getElementById("deal-id").value = "";
                
                populateSelect(document.getElementById("deal-company-select"), companies, "name", "id");
                populateSelectKeyVal(document.getElementById("deal-owner-select"), users);
                populateSelectArray(document.getElementById("deal-stage-select"), DEAL_STAGES);

                if (dealId) {
                    document.getElementById("deal-modal-title").textContent = "Edit Deal";
                    const deal = deals.find(d => d.id === dealId);
                    if (deal) {
                        document.getElementById("deal-id").value = deal.id;
                        document.getElementById("deal-name").value = deal.name;
                        document.getElementById("deal-company-select").value = deal.companyId;
                        document.getElementById("deal-value").value = deal.value;
                        document.getElementById("deal-stage-select").value = deal.stage;
                        document.getElementById("deal-owner-select").value = deal.owner;
                    }
                } else {
                    document.getElementById("deal-modal-title").textContent = "Add New Deal";
                }
                modal.classList.remove("hidden");
            }

            document.getElementById("deal-form").addEventListener("submit", e => {
                e.preventDefault();
                const id = parseInt(document.getElementById("deal-id").value);
                const dealData = {
                    name: document.getElementById("deal-name").value,
                    companyId: parseInt(document.getElementById("deal-company-select").value),
                    value: parseInt(document.getElementById("deal-value").value),
                    stage: document.getElementById("deal-stage-select").value,
                    owner: parseInt(document.getElementById("deal-owner-select").value),
                    contactIds: [] // Simplified for this prototype
                };

                if (id) {
                    const index = deals.findIndex(d => d.id === id);
                    if (index !== -1) deals[index] = { ...deals[index], ...dealData };
                } else {
                    dealData.id = getNextId(deals);
                    deals.push(dealData);
                }
                
                renderKanbanBoard();
                renderDashboard();
                document.getElementById("deal-modal").classList.add("hidden");
            });
            
            // Ticket Modal
            document.getElementById("add-ticket-btn").addEventListener("click", () => openTicketModal());
            
            function openTicketModal(ticketId = null) {
                const modal = document.getElementById("ticket-modal");
                const form = document.getElementById("ticket-form");
                form.reset();
                document.getElementById("ticket-id").value = "";
                
                populateSelect(document.getElementById("ticket-contact-select"), contacts, "name", "id");
                populateSelectKeyVal(document.getElementById("ticket-assignee-select"), users);
                populateSelectArray(document.getElementById("ticket-status-select"), TICKET_STATUSES);

                if (ticketId) {
                    document.getElementById("ticket-modal-title").textContent = "Edit Ticket";
                    const ticket = tickets.find(t => t.id === ticketId);
                    if (ticket) {
                        document.getElementById("ticket-id").value = ticket.id;
                        document.getElementById("ticket-subject").value = ticket.subject;
                        document.getElementById("ticket-contact-select").value = ticket.contactId;
                        document.getElementById("ticket-status-select").value = ticket.status;
                        document.getElementById("ticket-assignee-select").value = ticket.assignee;
                    }
                } else {
                    document.getElementById("ticket-modal-title").textContent = "Add New Ticket";
                }
                modal.classList.remove("hidden");
            }
            
            document.getElementById("ticket-form").addEventListener("submit", e => {
                e.preventDefault();
                const id = parseInt(document.getElementById("ticket-id").value);
                const ticketData = {
                    subject: document.getElementById("ticket-subject").value,
                    contactId: parseInt(document.getElementById("ticket-contact-select").value),
                    status: document.getElementById("ticket-status-select").value,
                    assignee: parseInt(document.getElementById("ticket-assignee-select").value),
                };

                if (id) {
                    const index = tickets.findIndex(t => t.id === id);
                    if (index !== -1) tickets[index] = { ...tickets[index], ...ticketData };
                } else {
                    ticketData.id = getNextId(tickets);
                    tickets.push(ticketData);
                }
                
                renderTicketList();
                renderDashboard();
                document.getElementById("ticket-modal").classList.add("hidden");
            });

            // Campaign Modal
            document.getElementById("add-campaign-btn").addEventListener("click", () => openCampaignModal());
            
            function openCampaignModal(campaignId = null) {
                const modal = document.getElementById("campaign-modal");
                const form = document.getElementById("campaign-form");
                form.reset();
                document.getElementById("campaign-id").value = "";
                
                populateSelectArray(document.getElementById("campaign-status-select"), CAMPAIGN_STATUSES);
                populateSelectArray(document.getElementById("campaign-channel-select"), CAMPAIGN_CHANNELS);

                if (campaignId) {
                    document.getElementById("campaign-modal-title").textContent = "Edit Campaign";
                    const campaign = campaigns.find(c => c.id === campaignId);
                    if (campaign) {
                        document.getElementById("campaign-id").value = campaign.id;
                        document.getElementById("campaign-name").value = campaign.name;
                        document.getElementById("campaign-status-select").value = campaign.status;
                        document.getElementById("campaign-budget").value = campaign.budget;
                        document.getElementById("campaign-channel-select").value = campaign.channel;
                    }
                } else {
                    document.getElementById("campaign-modal-title").textContent = "Add New Campaign";
                }
                modal.classList.remove("hidden");
            }
            
            document.getElementById("campaign-form").addEventListener("submit", e => {
                e.preventDefault();
                const id = parseInt(document.getElementById("campaign-id").value);
                const campaignData = {
                    name: document.getElementById("campaign-name").value,
                    status: document.getElementById("campaign-status-select").value,
                    budget: parseInt(document.getElementById("campaign-budget").value),
                    channel: document.getElementById("campaign-channel-select").value,
                };

                if (id) {
                    const index = campaigns.findIndex(c => c.id === id);
                    if (index !== -1) campaigns[index] = { ...campaigns[index], ...campaignData };
                } else {
                    campaignData.id = getNextId(campaigns);
                    campaigns.push(campaignData);
                }
                
                renderCampaignList();
                renderDashboard();
                document.getElementById("campaign-modal").classList.add("hidden");
            });
            
            // Event Modal (NEW)
            document.getElementById("add-event-btn").addEventListener("click", () => openEventModal());
            
            function openEventModal(dateString = null, eventId = null) {
                const modal = document.getElementById("event-modal");
                const form = document.getElementById("event-form");
                form.reset();
                document.getElementById("event-id").value = "";
                
                populateSelectArray(document.getElementById("event-type-select"), EVENT_TYPES);

                if (eventId) {
                    // Edit Mode
                    document.getElementById("event-modal-title").textContent = "Edit Event";
                    const event = events.find(e => e.id === eventId);
                    if (event) {
                        document.getElementById("event-id").value = event.id;
                        document.getElementById("event-title").value = event.title;
                        document.getElementById("event-date").value = event.date;
                        document.getElementById("event-start-time").value = event.startTime;
                        document.getElementById("event-end-time").value = event.endTime;
                        document.getElementById("event-type-select").value = event.type;
                    }
                } else {
                    // Add Mode
                    document.getElementById("event-modal-title").textContent = "Add New Event";
                    if (dateString) {
                        document.getElementById("event-date").value = dateString;
                    }
                }
                modal.classList.remove("hidden");
            }
            
            document.getElementById("event-form").addEventListener("submit", e => {
                e.preventDefault();
                const id = parseInt(document.getElementById("event-id").value);
                const eventData = {
                    title: document.getElementById("event-title").value,
                    date: document.getElementById("event-date").value,
                    startTime: document.getElementById("event-start-time").value,
                    endTime: document.getElementById("event-end-time").value,
                    type: document.getElementById("event-type-select").value,
                };

                if (id) {
                    const index = events.findIndex(e => e.id === id);
                    if (index !== -1) events[index] = { ...events[index], ...eventData };
                } else {
                    eventData.id = getNextId(events);
                    events.push(eventData);
                }
                
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                document.getElementById("event-modal").classList.add("hidden");
            });


            // --- Event Listeners for Edit/Delete ---
            
            // Detail Page "Edit" button
            document.getElementById("contact-detail-edit-btn").addEventListener("click", (e) => {
                openContactModal(currentContactId);
            });

            // Event delegation for table buttons
            document.body.addEventListener("click", e => {
                const target = e.target;
                
                // Contact List
                if (target.matches(".contact-detail-link")) {
                    e.preventDefault();
                    showContactDetail(parseInt(target.dataset.id));
                }
                if (target.matches(".contact-edit-btn")) openContactModal(parseInt(target.dataset.id));
                if (target.matches(".contact-delete-btn")) {
                    contacts = contacts.filter(c => c.id !== parseInt(target.dataset.id));
                    renderContactList();
                    renderDashboard();
                }

                // Company List
                if (target.matches(".company-edit-btn")) openCompanyModal(parseInt(target.dataset.id));
                if (target.matches(".company-delete-btn")) {
                    companies = companies.filter(c => c.id !== parseInt(target.dataset.id));
                    renderCompanyList();
                }
                
                // Deal Kanban
                if (target.closest(".deal-edit-btn")) {
                    const btn = target.closest(".deal-edit-btn");
                    openDealModal(parseInt(btn.dataset.id));
                }

                // Ticket List
                if (target.matches(".ticket-edit-btn")) openTicketModal(parseInt(target.dataset.id));
                if (target.matches(".ticket-delete-btn")) {
                    tickets = tickets.filter(t => t.id !== parseInt(target.dataset.id));
                    renderTicketList();
                    renderDashboard();
                }
                
                // Campaign List
                if (target.matches(".campaign-edit-btn")) openCampaignModal(parseInt(target.dataset.id));
                if (target.matches(".campaign-delete-btn")) {
                    campaigns = campaigns.filter(c => c.id !== parseInt(target.dataset.id));
                    renderCampaignList();
                    renderDashboard();
                }
                
                // Calendar Clicks
                if (target.closest(".add-event-on-date")) {
                    const date = target.closest(".add-event-on-date").dataset.date;
                    openEventModal(date);
                }
                if (target.closest(".event-edit-btn")) {
                    const eventId = parseInt(target.closest(".event-edit-btn").dataset.id);
                    openEventModal(null, eventId);
                }
            });

            // Back to Contacts list
            document.getElementById("back-to-contacts-btn").addEventListener("click", e => {
                e.preventDefault();
                showPage("page-contact-list");
            });

            // Activity Composer Tabs
            const activityTabs = document.querySelectorAll('.activity-tab');
            const activityContents = document.querySelectorAll('.activity-tab-content');
            
            activityTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    activityTabs.forEach(t => t.classList.remove('active'));
                    activityContents.forEach(c => c.classList.add('hidden'));
                    
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
                });
            });
            
            // Log Activity Buttons
            document.getElementById("log-call-btn").addEventListener("click", () => {
                const notes = document.getElementById("log-call-notes").value;
                if (!notes) return;
                activities.push({
                    id: getNextId(activities), type: "call", contactId: currentContactId,
                    date: "Just now", user: "Alex Johnson", notes: notes
                });
                renderActivityTimeline(currentContactId);
                document.getElementById("log-call-notes").value = "";
            });
            
            document.getElementById("log-email-btn").addEventListener("click", () => {
                const subject = document.getElementById("log-email-subject").value;
                const body = document.getElementById("log-email-body").value;
                if (!subject || !body) return;
                activities.push({
                    id: getNextId(activities), type: "email", contactId: currentContactId,
                    date: "Just now", user: "Alex Johnson", subject: subject, body: body
                });
                renderActivityTimeline(currentContactId);
                document.getElementById("log-email-subject").value = "";
                document.getElementById("log-email-body").value = "";
            });

            document.getElementById("log-meeting-btn").addEventListener("click", () => {
                const title = document.getElementById("log-meeting-title").value;
                const agenda = document.getElementById("log-meeting-agenda").value;
                if (!title) return;
                activities.push({
                    id: getNextId(activities), type: "meeting", contactId: currentContactId,
                    date: "Just now", user: "Alex Johnson", title: title, agenda: agenda
                });
                renderActivityTimeline(currentContactId);
                document.getElementById("log-meeting-title").value = "";
                document.getElementById("log-meeting-agenda").value = "";
            });
            
            // Calendar Navigation
            document.getElementById("calendar-today-btn").addEventListener("click", () => {
                currentCalendarDate = new Date();
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });
            document.getElementById("calendar-prev-btn").addEventListener("click", () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });
            document.getElementById("calendar-next-btn").addEventListener("click", () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });
            
            // Kanban Drag & Drop
            let draggedCard = null;
            const kanbanBoardContainer = document.getElementById('kanban-board-container');

            kanbanBoardContainer.addEventListener("dragstart", (e) => {
                if (e.target.classList.contains("kanban-card")) {
                    draggedCard = e.target;
                    setTimeout(() => e.target.classList.add("dragging"), 0);
                }
            });

            kanbanBoardContainer.addEventListener("dragend", (e) => {
                if (draggedCard) {
                    draggedCard.classList.remove("dragging");
                    draggedCard = null;
                }
            });

            kanbanBoardContainer.addEventListener("dragover", (e) => {
                e.preventDefault();
                const column = e.target.closest(".kanban-cards");
                if (column) {
                    column.appendChild(draggedCard); // Simplified logic
                }
            });

            kanbanBoardContainer.addEventListener("drop", (e) => {
                e.preventDefault();
                const column = e.target.closest("[data-stage]");
                if (column && draggedCard) {
                    const newStage = column.dataset.stage;
                    const dealId = parseInt(draggedCard.dataset.id);
                    
                    const deal = deals.find(d => d.id === dealId);
                    if (deal) deal.stage = newStage;
                    
                    renderKanbanBoard(); 
                    renderDashboard();
                }
            });

            // --- Initial Load ---
            function init() {
                renderContactList();
                renderCompanyList();
                renderTicketList();
                renderCampaignList();
                renderKanbanBoard();
                renderDashboard();
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                
                // Show dashboard by default
                showPage("page-dashboard");
                
                // Render all icons
                lucide.createIcons();
            }

            init();
        });
    </script>
</body>
</html>



